name: Create release of ESP32 firmware, Python provisioning tool and Android app

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Enter the version in format X.X.X"
        required: true
        default: "1.0.0"
        type: string

env:
  ANDROID_CONTROL_CLIENT_PATH: "./android_control_client"
  ESP32_PROJECT_PATH: "./esp32_firmware"
  ESP32_PROVISIONING_TOOL_PATH: "./esp32_provisioning_tool"

jobs:
  build-esp32-firmware:
    runs-on: ubuntu-latest
    container: espressif/idf:release-v5.5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build firmware
        working-directory: ${{ env.ESP32_PROJECT_PATH }}
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target esp32
          make build-app VER="${{ inputs.version }}"

      - name: Rename and prepare binary
        working-directory: ${{ env.ESP32_PROJECT_PATH }}/build
        run: mv esp32_firmware.bin esp32-firmware-v${{ inputs.version }}.bin

      - name: Generate firmware hash
        working-directory: ${{ env.ESP32_PROJECT_PATH }}/build
        run: |
          HASH=$(sha256sum esp32-firmware-v${{ inputs.version }}.bin | awk '{print $1}')
          echo "sha256:$HASH" > esp32-firmware-v${{ inputs.version }}-hash.txt

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v6
        with:
          name: htas-esp32-firmware
          path: |
            ${{ env.ESP32_PROJECT_PATH }}/build/esp32-firmware-v${{ inputs.version }}.bin
            ${{ env.ESP32_PROJECT_PATH }}/build/esp32-firmware-v${{ inputs.version }}-hash.txt

  esp32-firmware-doxygen:
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Doxygen and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
      
      - name: Generate documentation
        working-directory: ${{ env.ESP32_PROJECT_PATH }}
        run: make docs VER="${{ inputs.version }}"

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.ESP32_PROJECT_PATH }}/docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-android-control-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ${{ env.ANDROID_CONTROL_CLIENT_PATH }}/gradlew

      - name: Build release APK
        working-directory: ${{ env.ANDROID_CONTROL_CLIENT_PATH }}
        env:
          APP_VER: ${{ inputs.version }}
        run: ./gradlew assembleRelease

      - name: Rename APK
        run: |
          find ${{ env.ANDROID_CONTROL_CLIENT_PATH }}/app/build/outputs/apk/release -name "*.apk" \
          -exec mv {} android-control-client-v${{ inputs.version }}.apk \;

      - name: Upload Android artifact
        uses: actions/upload-artifact@v6
        with:
          name: htas-android-app
          path: android-control-client-v${{ inputs.version }}.apk

  build-provisioning-tool:
    name: Build provisioning tool (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: provisioning-tool-linux
            executable_ext: ""
          - os: windows-latest
            asset_name: provisioning-tool-win
            executable_ext: ".exe"
          - os: macos-15-intel
            asset_name: provisioning-tool-macos
            executable_ext: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Make (win)
        if: runner.os == 'Windows'
        run: choco install make

      - name: Build with Make
        working-directory: ${{ env.ESP32_PROVISIONING_TOOL_PATH }}
        run: make install build APP_VER=${{ inputs.version }}

      - name: Rename for release
        shell: bash
        working-directory: ${{ env.ESP32_PROVISIONING_TOOL_PATH }}/dist
        run: |
          mv esp32-provisioning-tool-v${{ inputs.version }}${{ matrix.executable_ext }} \
          ${{ matrix.asset_name }}-v${{ inputs.version }}${{ matrix.executable_ext }}

      - name: Upload ESP32 provisioning tool artifact
        uses: actions/upload-artifact@v6
        with:
          name: htas-${{ matrix.asset_name }}
          path: ${{ env.ESP32_PROVISIONING_TOOL_PATH }}/dist/*

  create-release:
    runs-on: ubuntu-latest
    needs:
      - build-esp32-firmware
      - esp32-firmware-doxygen
      - build-android-control-client
      - build-provisioning-tool

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v7
        with:
          path: release-assets
          merge-multiple: true
          pattern: htas-*

      - name: Create signed GPG tag
        uses: rickstaa/action-create-tag@v1
        with:
          tag: v${{ github.event.inputs.version }}
          message: "Release v${{ github.event.inputs.version }}"
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.GPG_KEY_PASSPHRASE }}

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          generate_release_notes: true
          files: ./release-assets/*
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Release v${{ inputs.version }} of Home Theater Automation System.
            Install and connect procedure you will find in `INSTALL.md` file.
            ESP32 firmware docs you will find [here](${{ needs.esp32-firmware-doxygen.outputs.page_url }}).
